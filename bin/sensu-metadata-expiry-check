#!/usr/bin/env ruby

require 'sensu-plugin/check/cli'
require 'metadata/checker'

class SensuMetadataExpiryCheck < Sensu::Plugin::Check::CLI

  check_name 'metadata_expiry_check' # defaults to class name
  option :host, :short => '-h HOST', required: true
  option :disable_hostname_verification,
         :short => '--disable-hostname-verification',
         boolean: true,
         default: false
  option :warning_threshold_days,
         :short => '-w DAYS',
         required: false,
         default: 30
  option :critical_threshold_days,
         :short => '-c DAYS',
         required: false,
         default: 10

  
  def run
    (expired, near_expiry) = Metadata::Checker::check_expiry(config[:host],
                                                             config[:disable_hostname_verification],
                                                             config[:warning_threshold_days].to_i,
                                                             config[:critical_threshold_days].to_i)
    if expired.any?
      critical expired.map(&:message).join("\n")
    elsif near_expiry.any?
      warning near_expiry.map(&:message).join("\n")
    else
      ok "no certificates near expiry"
    end
  end
end
