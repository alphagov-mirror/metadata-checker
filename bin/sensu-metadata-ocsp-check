#!/usr/bin/env ruby

require 'sensu-plugin/check/cli'
require 'metadata/checker'

class SensuMetadataOcspCheck < Sensu::Plugin::Check::CLI

  check_name 'metadata_ocsp_check' # defaults to class name
  option :host, :short => '-h HOST', required: true
  option :ca_file_list, :long => '--cas FILES', required: true
  option :signing_ca_file_list, :long => '--signing_cas FILES', required: false
  option :disable_hostname_verification,
      :short => '--disable-hostname-verification',
      boolean: true,
      default: false

  def run
    ca_files = config[:ca_file_list].split(",")
    signing_ca_files = String(config[:signing_ca_file_list]).split(",")
    revocations = Metadata::Checker::check_ocsp(config[:host], ca_files, signing_ca_files, config[:disable_hostname_verification])
    if revocations.any?
      critical revocations.map(&:message).join("\n")
    else
      ok "no revoked certificates"
    end
  end
end
